<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live AQI Tracker - Real-Time Pollution Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .tracking-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .map-container {
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .aqi-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .aqi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .aqi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .aqi-value {
            font-size: 60px;
            font-weight: bold;
            animation: slideUp 0.5s ease;
        }

        .aqi-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .aqi-change {
            font-size: 24px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .change-arrow {
            font-size: 30px;
        }

        .arrow-up { color: #ef4444; }
        .arrow-down { color: #10b981; }
        .arrow-stable { color: #f59e0b; }

        .tracking-status {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
            border-left: 4px solid #10b981;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-icon.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            animation: pulse 2s infinite;
        }

        .status-text {
            flex: 1;
        }

        .status-text .label {
            font-weight: 600;
            color: #333;
        }

        .status-text .value {
            color: #666;
            font-size: 14px;
        }

        .journey-log {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .journey-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            animation: slideUp 0.3s ease;
        }

        .journey-item:last-child {
            border-bottom: none;
        }

        .journey-time {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            min-width: 50px;
            text-align: center;
        }

        .journey-aqi {
            margin: 0 15px;
            font-weight: bold;
            font-size: 18px;
            min-width: 40px;
        }

        .journey-location {
            flex: 1;
            font-size: 14px;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn-control {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

        .health-recommendations {
            background: rgba(248, 113, 113, 0.1);
            border-left: 4px solid #ef4444;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .health-recommendations.good {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }

        .health-recommendations h5 {
            color: #ef4444;
            font-weight: 600;
        }

        .health-recommendations.good h5 {
            color: #10b981;
        }

        .pm-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .pm-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #f0f0f0;
        }

        .pm-label {
            font-size: 12px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pm-value {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
            margin-top: 5px;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .no-data i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .aqi-display {
                grid-template-columns: 1fr;
            }

            .aqi-value {
                font-size: 50px;
            }

            .map-container {
                height: 400px;
            }

            .controls {
                flex-direction: column;
            }

            .btn-control {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div style="padding: 20px 0;">
            <h1 style="color: white; text-align: center; font-weight: bold; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
                <i class="fas fa-location-crosshairs"></i> Live AQI Tracker
            </h1>
            <p style="color: rgba(255, 255, 255, 0.9); text-align: center; font-size: 16px;">
                Real-time pollution monitoring as you move
            </p>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Main Container -->
                <div class="tracking-container">
                    <!-- Controls -->
                    <div class="controls">
                        <button class="btn-control btn-primary" id="startBtn" onclick="startTracking()">
                            <i class="fas fa-play"></i> Start Tracking
                        </button>
                        <button class="btn-control btn-danger" id="stopBtn" onclick="stopTracking()" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Tracking
                        </button>
                        <button class="btn-control btn-primary" onclick="clearJourney()">
                            <i class="fas fa-trash"></i> Clear Journey
                        </button>
                        <button class="btn-control btn-primary" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>

                    <!-- Tracking Status -->
                    <div class="tracking-status" id="trackingStatus">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="status-text">
                                <div class="label">Status</div>
                                <div class="value" id="statusText">Ready to track</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="status-text">
                                <div class="label">Current Location</div>
                                <div class="value" id="locationText">Waiting for location...</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-route"></i>
                            </div>
                            <div class="status-text">
                                <div class="label">Distance Traveled</div>
                                <div class="value" id="distanceText">0 km</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon active">
                                <i class="fas fa-sync"></i>
                            </div>
                            <div class="status-text">
                                <div class="label">Updates</div>
                                <div class="value" id="updateCount">0 AQI updates</div>
                            </div>
                        </div>
                    </div>

                    <!-- Map -->
                    <div class="map-container" id="trackingMap"></div>

                    <!-- Current AQI Display -->
                    <div class="aqi-display">
                        <div class="aqi-card" id="currentAQICard">
                            <div class="aqi-value" id="currentAQI">--</div>
                            <div class="aqi-label" id="currentCategory">Fetching data...</div>
                            <div class="aqi-change" id="aqiChange">
                                <span class="change-arrow arrow-stable">â†’</span>
                                <span id="changeText">No change yet</span>
                            </div>
                        </div>
                        <div class="aqi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="aqi-value" id="previousAQI">--</div>
                            <div class="aqi-label">Previous AQI</div>
                            <div class="aqi-change" id="timeSince">
                                <i class="fas fa-clock"></i>
                                <span id="timeSinceText">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- PM Details -->
                    <div class="pm-details">
                        <div class="pm-item">
                            <div class="pm-label">PM 2.5</div>
                            <div class="pm-value" id="pm25Value">--</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">Âµg/mÂ³</div>
                        </div>
                        <div class="pm-item">
                            <div class="pm-label">PM 10</div>
                            <div class="pm-value" id="pm10Value">--</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">Âµg/mÂ³</div>
                        </div>
                    </div>

                    <!-- Health Recommendations -->
                    <div class="health-recommendations good" id="healthRecommendations">
                        <h5 id="healthTitle"><i class="fas fa-heart-pulse"></i> Health Recommendations</h5>
                        <p id="healthMessage">Start tracking to see real-time health recommendations based on current AQI in your area.</p>
                    </div>

                    <!-- Journey Log -->
                    <div>
                        <h5 style="margin-top: 30px; font-weight: 600; color: #333;">
                            <i class="fas fa-history"></i> Journey Log
                        </h5>
                        <div class="journey-log" id="journeyLog">
                            <div class="no-data">
                                <i class="fas fa-map-location-dot"></i>
                                <p>Your journey will be recorded here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============ STATE MANAGEMENT ============
        const state = {
            tracking: false,
            watchId: null,
            map: null,
            userMarker: null,
            pathPolyline: null,
            previousAQI: null,
            previousLocation: null,
            distanceTraveled: 0,
            updateCount: 0,
            journey: [],
            lastUpdateDistance: 0  // Only update AQI after moving 1km
        };

        // ============ INITIALIZE MAP ============
        function initializeMap() {
            state.map = L.map('trackingMap').setView([20.5937, 78.9629], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(state.map);

            // Initialize polyline for path
            state.pathPolyline = L.polyline([], {
                color: '#3b82f6',
                weight: 3,
                opacity: 0.7,
                dashArray: '5, 5'
            }).addTo(state.map);
        }

        // ============ START TRACKING ============
        function startTracking() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';

            updateStatus('Tracking started... Getting location...', '#3b82f6');

            // Watch position every 5-10 seconds
            state.watchId = navigator.geolocation.watchPosition(
                onLocationSuccess,
                onLocationError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
        }

        // ============ STOP TRACKING ============
        function stopTracking() {
            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }

            state.tracking = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';

            updateStatus('Tracking stopped', '#ef4444');
        }

        // ============ HANDLE LOCATION SUCCESS ============
        function onLocationSuccess(position) {
            const { latitude, longitude } = position.coords;

            // Calculate distance from previous location
            if (state.previousLocation) {
                const distance = haversineDistance(
                    state.previousLocation.lat,
                    state.previousLocation.lng,
                    latitude,
                    longitude
                );

                state.distanceTraveled += distance;
                state.lastUpdateDistance += distance;
            }

            state.previousLocation = { lat: latitude, lng: longitude };

            // Update map
            updateMap(latitude, longitude);

            // Update status
            const locationName = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
            document.getElementById('locationText').textContent = locationName;
            document.getElementById('distanceText').textContent = `${state.distanceTraveled.toFixed(2)} km`;

            // Fetch AQI only if moved 1km (or first time)
            if (state.lastUpdateDistance >= 1 || !state.tracking) {
                fetchAQI(latitude, longitude);
                state.lastUpdateDistance = 0;
            }

            updateStatus('Tracking active', '#10b981');
            state.tracking = true;
        }

        // ============ HANDLE LOCATION ERROR ============
        function onLocationError(error) {
            let message = 'Location error: ';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Permission denied. Please enable location access.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Position unavailable';
                    break;
                case error.TIMEOUT:
                    message += 'Request timeout';
                    break;
            }
            console.error(message);
            updateStatus(message, '#ef4444');
        }

        // ============ FETCH AQI FROM BACKEND ============
        async function fetchAQI(lat, lng) {
            try {
                const response = await fetch(
                    `http://127.0.0.1:5000/aqi/current?lat=${lat}&lng=${lng}`
                );
                const data = await response.json();

                if (data.aqi !== null && data.aqi !== undefined) {
                    // Calculate change from previous AQI
                    let change = 0;
                    if (state.previousAQI !== null) {
                        change = data.aqi - state.previousAQI;
                    }

                    // Update display
                    displayAQI(data, change);

                    // Add to journey
                    state.journey.push({
                        aqi: data.aqi,
                        location: data.location_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                        time: new Date(),
                        distance: state.distanceTraveled
                    });

                    state.previousAQI = data.aqi;
                    state.updateCount++;
                    document.getElementById('updateCount').textContent = `${state.updateCount} AQI updates`;

                    updateJourneyLog();
                } else {
                    console.error('No AQI data received');
                }
            } catch (error) {
                console.error('Error fetching AQI:', error);
            }
        }

        // ============ DISPLAY AQI ============
        function displayAQI(data, change) {
            const aqi = data.aqi;
            const category = data.category || 'Unknown';
            const pm25 = data.pm25 || '--';
            const pm10 = data.pm10 || '--';

            // Update AQI values
            document.getElementById('currentAQI').textContent = aqi;
            document.getElementById('currentCategory').textContent = category;
            document.getElementById('pm25Value').textContent = pm25 !== '--' ? pm25.toFixed(1) : '--';
            document.getElementById('pm10Value').textContent = pm10 !== '--' ? pm10.toFixed(1) : '--';

            // Update previous AQI
            if (state.previousAQI !== null) {
                document.getElementById('previousAQI').textContent = state.previousAQI;
            }

            // Update change indicator
            const changeElement = document.getElementById('aqiChange');
            const changeText = document.getElementById('changeText');

            if (change > 0) {
                changeText.innerHTML = `<span class="arrow-up">â†‘</span> +${change} (Worsening)`;
                changeElement.querySelector('.change-arrow').className = 'change-arrow arrow-up';
            } else if (change < 0) {
                changeText.innerHTML = `<span class="arrow-down">â†“</span> ${change} (Improving)`;
                changeElement.querySelector('.change-arrow').className = 'change-arrow arrow-down';
            } else {
                changeText.innerHTML = '<span class="arrow-stable">â†’</span> No change';
                changeElement.querySelector('.change-arrow').className = 'change-arrow arrow-stable';
            }

            // Color card based on AQI
            const card = document.getElementById('currentAQICard');
            if (aqi <= 50) {
                card.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (aqi <= 100) {
                card.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else if (aqi <= 200) {
                card.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else if (aqi <= 300) {
                card.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)';
            } else {
                card.style.background = 'linear-gradient(135deg, #3b0764 0%, #1a0033 100%)';
            }

            // Update health recommendations
            updateHealthRecommendations(category, data.health_message);
        }

        // ============ UPDATE HEALTH RECOMMENDATIONS ============
        function updateHealthRecommendations(category, message) {
            const element = document.getElementById('healthRecommendations');
            const title = document.getElementById('healthTitle');
            const messageEl = document.getElementById('healthMessage');

            messageEl.textContent = message || 'Check air quality before outdoor activities';

            if (category === 'Good') {
                element.classList.add('good');
                title.innerHTML = '<i class="fas fa-face-smile"></i> Great Air Quality!';
            } else if (category === 'Satisfactory' || category === 'Moderate') {
                element.classList.remove('good');
                title.innerHTML = '<i class="fas fa-face-meh"></i> Caution Advised';
            } else {
                element.classList.remove('good');
                title.innerHTML = '<i class="fas fa-face-frown"></i> Air Quality Warning';
            }
        }

        // ============ UPDATE MAP ============
        function updateMap(lat, lng) {
            // Add or update user marker
            if (state.userMarker) {
                state.userMarker.setLatLng([lat, lng]);
            } else {
                state.userMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: '#3b82f6',
                    color: '#1e40af',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(state.map);
            }

            // Add to path polyline
            state.pathPolyline.addLatLng([lat, lng]);

            // Center map on user
            state.map.setView([lat, lng], 13);
        }

        // ============ UPDATE JOURNEY LOG ============
        function updateJourneyLog() {
            const log = document.getElementById('journeyLog');

            if (state.journey.length === 0) {
                log.innerHTML = '<div class="no-data"><i class="fas fa-map-location-dot"></i><p>Your journey will be recorded here</p></div>';
                return;
            }

            log.innerHTML = state.journey.map((entry, index) => {
                const time = new Date(entry.time);
                const timeStr = time.toLocaleTimeString();

                return `
                    <div class="journey-item">
                        <div class="journey-time">${timeStr}</div>
                        <div class="journey-aqi" style="background: ${getAQIColor(entry.aqi)}; color: white; padding: 5px 10px; border-radius: 5px;">
                            ${entry.aqi}
                        </div>
                        <div class="journey-location">
                            <strong>${entry.location}</strong><br>
                            <small>Distance: ${entry.distance?.toFixed(2) || 0} km</small>
                        </div>
                    </div>
                `;
            }).reverse().join('');
        }

        // ============ HELPER: GET AQI COLOR ============
        function getAQIColor(aqi) {
            if (aqi <= 50) return '#10b981';
            if (aqi <= 100) return '#f59e0b';
            if (aqi <= 200) return '#ef4444';
            if (aqi <= 300) return '#8b5cf6';
            return '#3b0764';
        }

        // ============ HELPER: CALCULATE DISTANCE ============
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ============ UPDATE STATUS ============
        function updateStatus(text, color) {
            const statusText = document.getElementById('statusText');
            statusText.textContent = text;
            statusText.style.color = color;
        }

        // ============ CLEAR JOURNEY ============
        function clearJourney() {
            if (confirm('Clear all journey data?')) {
                state.journey = [];
                state.distanceTraveled = 0;
                state.updateCount = 0;
                state.previousAQI = null;
                updateJourneyLog();
                document.getElementById('distanceText').textContent = '0 km';
                document.getElementById('updateCount').textContent = '0 AQI updates';
            }
        }

        // ============ INITIALIZE ON PAGE LOAD ============
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            console.log('âœ… Live AQI Tracker Ready');
            console.log('ðŸ“ Click "Start Tracking" to begin monitoring AQI changes as you move');
        });
    </script>
</body>
</html>
