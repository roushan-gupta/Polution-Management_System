# üåç Real-Time AQI Integration Guide

## Current Status: Demo Mode with Sample Data

Your application currently shows **sample test data** generated randomly. To display **real-time AQI**, you need to integrate with external AQI data providers.

---

## ‚ö†Ô∏è Why Test Data Shows Different Values

**Your App (400 AQI):** Random test data generated by `/aqi/populate-test-data`
**External Sites (168 AQI):** Real-time data from actual monitoring stations

### The Difference:
- **Test Data:** Generated with `random.randint(15, 150)` - not connected to reality
- **Real Data:** From actual air quality sensors measuring PM2.5, PM10, etc.

---

## üîë Option 1: WAQI (World Air Quality Index) API - RECOMMENDED

**Best for:** Real-time global AQI data with high reliability

### Features:
‚úÖ 12,000+ monitoring stations worldwide
‚úÖ Real-time data updates
‚úÖ Covers major Indian cities
‚úÖ Free tier available
‚úÖ No credit card required

### Setup Steps:

1. **Get Free API Key**
   - Visit: https://aqicn.org/api/
   - Click "Request API Token"
   - Fill form (takes 2-3 days for approval)
   - Free tier: 1000 requests/minute

2. **Update Backend Code**
   
   Open `backend/routes/aqi.py` and uncomment WAQI section:
   
   ```python
   # Add your API key
   WAQI_API_KEY = "your_api_key_here"  # Get from https://aqicn.org/api/
   
   # Uncomment lines 138-155 in aqi.py
   waqi_url = f"https://api.waqi.info/feed/geo:{lat};{lng}/?token={WAQI_API_KEY}"
   waqi_response = requests.get(waqi_url, timeout=10)
   if waqi_response.status_code == 200:
       waqi_data = waqi_response.json()
       if waqi_data.get('status') == 'ok':
           aqi_value = waqi_data['data']['aqi']
           pm25 = waqi_data['data'].get('iaqi', {}).get('pm25', {}).get('v')
           pm10 = waqi_data['data'].get('iaqi', {}).get('pm10', {}).get('v')
           severity = get_aqi_category(aqi_value)
           return jsonify({
               "aqi": aqi_value,
               "pm25": pm25,
               "pm10": pm10,
               "category": severity["category"],
               "health_message": severity["health_message"],
               "source": f"WAQI - {waqi_data['data']['city']['name']}"
           }), 200
   ```

3. **Test**
   ```bash
   curl "http://127.0.0.1:5000/aqi/current?lat=28.6139&lng=77.2090"
   ```

### API Endpoints:
```
# By coordinates
https://api.waqi.info/feed/geo:{lat};{lon}/?token={token}

# By city name
https://api.waqi.info/feed/{city}/?token={token}

# Example
https://api.waqi.info/feed/delhi/?token=demo
```

---

## üåê Option 2: OpenAQ API - Already Integrated (Limited Coverage)

**Status:** Already implemented in your code but limited Indian coverage

### Current Implementation:
- Already in `aqi.py` lines 156-176
- No API key required
- Free to use
- Limited stations in India

### Issues:
- Few monitoring stations in India
- May not have data for many locations
- Less reliable than WAQI

### When It Works:
You'll see: `"source": "OpenAQ Station (External API)"`

---

## üáÆüá≥ Option 3: CPCB (Central Pollution Control Board) API

**Best for:** Official Indian government data

### Features:
‚úÖ Official CPCB data
‚úÖ Covers major Indian cities
‚úÖ Free API (when available)
‚úÖ Most accurate for India

### Challenge:
- No public API documentation
- Need to scrape data or get official access
- Contact: https://cpcb.nic.in/

### Alternative - Use AQI.in Data:
Since you showed aqi.in website, you could:
1. Web scraping (not recommended, may violate ToS)
2. Contact them for API access
3. Use their widgets if available

---

## üí° Option 4: Government Open Data

### India Urban Data Exchange (IUDX)
- Website: https://iudx.org.in/
- Provides air quality data APIs
- Free for developers
- Real-time data from multiple cities

### Steps:
1. Register at https://catalogue.iudx.org.in/
2. Get API credentials
3. Integrate with your backend

---

## üîß Implementation Priority

### **Immediate (Demo):**
‚úÖ Keep test data with clear warnings (DONE)
‚úÖ Add "Test Data" labels everywhere (DONE)
‚úÖ Implement geocoding search (DONE)

### **Short Term (Real Data):**
1. Get WAQI API key (2-3 days approval)
2. Uncomment WAQI code in aqi.py
3. Test with real coordinates
4. Remove "Test Data" warnings

### **Long Term (Production):**
1. Set up CPCB/IUDX integration
2. Add data caching (reduce API calls)
3. Store historical data
4. Add data visualization charts

---

## üìä How to Show Real Data Now

### Quick Fix - Manual Entry:

1. **Get Real AQI Values**
   - Visit: https://aqi.in or https://aqicn.org
   - Note down AQI for cities you want

2. **Update Database Manually**
   ```sql
   -- Update Delhi's AQI with real value
   UPDATE aqi_readings 
   SET aqi = 168, pm25 = 86, pm10 = 100, recorded_at = NOW()
   WHERE location_id = (SELECT location_id FROM locations WHERE name = 'Delhi Central');
   ```

3. **Create Scheduled Task**
   - Write Python script to fetch from WAQI
   - Run every 30 minutes with cron/Task Scheduler
   - Update database automatically

---

## üöÄ Production Deployment Checklist

### Before Going Live:
- [ ] Get WAQI API key
- [ ] Integrate real-time data source
- [ ] Set up data refresh schedule (every 30 min)
- [ ] Add error handling for API failures
- [ ] Cache API responses (5-10 minutes)
- [ ] Monitor API usage limits
- [ ] Add fallback to database if API fails
- [ ] Remove all "Test Data" warnings
- [ ] Test with real locations
- [ ] Add data accuracy disclaimer

---

## üéØ Recommended Solution

**For your use case, I recommend:**

### Phase 1: WAQI Integration (Week 1)
1. Apply for WAQI API key today
2. While waiting, use current test data
3. Once approved, integrate WAQI
4. Test thoroughly

### Phase 2: Database Caching (Week 2)
1. Store WAQI results in database
2. Refresh every 30 minutes
3. Use cached data if API fails
4. Add "Last Updated" timestamps

### Phase 3: Multiple Sources (Week 3)
1. Add IUDX/CPCB as backup
2. Compare multiple sources
3. Show average or most reliable
4. Add data quality indicators

---

## üìù Code Example: Complete WAQI Integration

Create `backend/services/waqi_service.py`:

```python
import requests
from datetime import datetime, timedelta

WAQI_API_KEY = "your_key_here"
CACHE_DURATION = 30  # minutes

class WAQIService:
    def __init__(self):
        self.cache = {}
    
    def get_aqi_by_coordinates(self, lat, lng):
        cache_key = f"{lat},{lng}"
        
        # Check cache
        if cache_key in self.cache:
            cached_time, cached_data = self.cache[cache_key]
            if datetime.now() - cached_time < timedelta(minutes=CACHE_DURATION):
                return cached_data
        
        # Fetch from API
        url = f"https://api.waqi.info/feed/geo:{lat};{lng}/?token={WAQI_API_KEY}"
        response = requests.get(url, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            if data.get('status') == 'ok':
                result = {
                    'aqi': data['data']['aqi'],
                    'pm25': data['data'].get('iaqi', {}).get('pm25', {}).get('v'),
                    'pm10': data['data'].get('iaqi', {}).get('pm10', {}).get('v'),
                    'city': data['data']['city']['name'],
                    'timestamp': datetime.now()
                }
                
                # Cache result
                self.cache[cache_key] = (datetime.now(), result)
                return result
        
        return None
    
    def get_aqi_by_city(self, city_name):
        url = f"https://api.waqi.info/feed/{city_name}/?token={WAQI_API_KEY}"
        response = requests.get(url, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            if data.get('status') == 'ok':
                return {
                    'aqi': data['data']['aqi'],
                    'pm25': data['data'].get('iaqi', {}).get('pm25', {}).get('v'),
                    'pm10': data['data'].get('iaqi', {}).get('pm10', {}).get('v'),
                    'city': data['data']['city']['name']
                }
        
        return None

# Usage in aqi.py
from services.waqi_service import WAQIService
waqi = WAQIService()

@aqi_bp.route("/aqi/current", methods=["GET"])
def current_location_aqi():
    lat = float(request.args.get("lat"))
    lng = float(request.args.get("lng"))
    
    # Try WAQI first
    waqi_data = waqi.get_aqi_by_coordinates(lat, lng)
    if waqi_data:
        severity = get_aqi_category(waqi_data['aqi'])
        return jsonify({
            "aqi": waqi_data['aqi'],
            "pm25": waqi_data['pm25'],
            "pm10": waqi_data['pm10'],
            "category": severity["category"],
            "health_message": severity["health_message"],
            "source": f"Real-time: {waqi_data['city']}"
        })
    
    # Fallback to database...
```

---

## üéì Learning Resources

### APIs & Documentation:
- **WAQI:** https://aqicn.org/api/
- **OpenAQ:** https://docs.openaq.org/
- **IUDX:** https://iudx.org.in/
- **AQI Standards:** https://www.airnow.gov/aqi/

### Understanding AQI:
- **CPCB AQI:** https://cpcb.nic.in/
- **US EPA AQI:** https://www.airnow.gov/
- **WHO Guidelines:** https://www.who.int/airpollution/

---

## ‚ö° Quick Start for Real Data

### Today (5 minutes):
```bash
# 1. Get WAQI demo token (limited)
# Visit: https://aqicn.org/api/

# 2. Test it works
curl "https://api.waqi.info/feed/delhi/?token=demo"

# 3. See real AQI in response!
```

### This Week:
1. Apply for free WAQI token
2. Update backend with your token
3. Deploy and test
4. Celebrate real data! üéâ

---

## üìû Support & Help

### If APIs Don't Work:
1. Check API key validity
2. Verify rate limits
3. Check API status: https://status.aqicn.org/
4. Use test data as fallback
5. Log errors for debugging

### Contact for Help:
- WAQI Support: contact@aqicn.org
- OpenAQ Forum: https://github.com/openaq/openaq-api
- Your App Issues: Check Flask logs

---

## ‚úÖ Summary

**Current State:**
- ‚ùå Test data (random values)
- ‚úÖ Working UI and features
- ‚úÖ Geocoding search working
- ‚úÖ Ready for real data integration

**Next Steps:**
1. **Get WAQI API key** (highest priority)
2. **Integrate WAQI** (5 lines of code)
3. **Test with real locations**
4. **Remove test data warnings**
5. **Deploy to production**

**Your app will then show real AQI matching external sources! üåç‚ú®**

---

*Last Updated: February 10, 2026*
*Status: Test Data ‚Üí Real Data Migration Guide*
